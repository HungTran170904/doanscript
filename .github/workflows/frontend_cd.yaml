name: Frontend_CD

on:
  workflow_dispatch:

env:
  IMAGE_NAME: dkhp-frontend
  WORK_DIR: dkhp_frontend
  AKS_NAMESPACE: app

jobs:
  cd:
    runs-on: ubuntu-latest
    environment: Prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        id: image
        run: |
          image_tag="${IMAGE_NAME}:${GITHUB_SHA::8}-${GITHUB_RUN_NUMBER}"
          docker build -t "$image_tag" "./${WORK_DIR}"
          echo "image_tag=${image_tag}" >> $GITHUB_OUTPUT

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.21.0
        with:
          image-ref: ${{ steps.image.outputs.image_tag }}
          exit-code: 1
          severity: CRITICAL
          format: json
          output: trivy-report.json

      - name: Login via Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Push docker image
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_USERNAME }}
          password: ${{ secrets.AZURE_PASSWORD }}
      - run: |
          docker tag ${{ steps.image.outputs.image_tag }} ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ steps.image.outputs.image_tag }}
          docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ steps.image.outputs.image_tag }}
      
      - name: Upload Trivy scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-report
          path: trivy-report.json
          if-no-files-found: warn

      - name: Get AKS credentials
        run: az aks get-credentials --resource-group ${{ secrets.RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER }} --overwrite-existing

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Upgrade Helm chart
        run: |
          cd ./k8s/application
          sed -i 's|^\(\s*repository:\s*\).*|\1${{ steps.image.outputs.image_ref }}|' ./frontend/values.yaml
          helm upgrade frontend ./frontend -n $AKS_NAMESPACE --install